#!/usr/bin/env python3
import json
import os
import sys
from datetime import datetime, timezone

TERMREC_DIR = os.path.expanduser(os.environ.get("TERMREC_DIR", "~/ops/termrec"))

def parse_ts(ts):
    return datetime.strptime(ts, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=timezone.utc)


def load_meta_for_date(date_str):
    day_dir = os.path.join(TERMREC_DIR, date_str)
    if not os.path.isdir(day_dir):
        return []
    metas = []
    for name in os.listdir(day_dir):
        if name.endswith(".meta.json"):
            path = os.path.join(day_dir, name)
            try:
                with open(path, "r", encoding="utf-8") as f:
                    metas.append(json.load(f))
            except Exception:
                pass
    return metas


def main():
    date_str = None
    if len(sys.argv) > 1:
        date_str = sys.argv[1]
    else:
        date_str = datetime.now().astimezone().strftime("%Y-%m-%d")

    metas = load_meta_for_date(date_str)
    total_seconds = 0
    by_tool = {}
    sessions = 0

    for m in metas:
        start = m.get("start_ts")
        end = m.get("end_ts")
        if not start or not end:
            continue
        try:
            dur = int((parse_ts(end) - parse_ts(start)).total_seconds())
        except Exception:
            continue
        if dur < 0:
            continue
        tool = m.get("tool", "unknown")
        total_seconds += dur
        by_tool[tool] = by_tool.get(tool, 0) + dur
        sessions += 1

    summary = {
        "date": date_str,
        "sessions": sessions,
        "total_seconds": total_seconds,
        "by_tool": by_tool,
    }

    out_json = os.path.join(TERMREC_DIR, f"summary-{date_str}.json")
    out_txt = os.path.join(TERMREC_DIR, f"summary-{date_str}.txt")

    os.makedirs(TERMREC_DIR, exist_ok=True)
    with open(out_json, "w", encoding="utf-8") as f:
        json.dump(summary, f, indent=2, sort_keys=True)

    def fmt(sec):
        h = sec // 3600
        m = (sec % 3600) // 60
        return f"{h}h {m}m"

    with open(out_txt, "w", encoding="utf-8") as f:
        f.write(f"Date: {date_str}\n")
        f.write(f"Sessions: {sessions}\n")
        f.write(f"Total: {fmt(total_seconds)}\n")
        for tool, sec in sorted(by_tool.items(), key=lambda x: x[1], reverse=True):
            f.write(f"{tool}: {fmt(sec)}\n")

    print(out_json)
    print(out_txt)


if __name__ == "__main__":
    main()
